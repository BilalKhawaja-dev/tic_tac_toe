name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: eu-west-2
  ECR_REPOSITORY: global-gaming-platform

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x]
        python-version: [3.9]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Node.js dependencies
      run: |
        npm ci
        npm run install:all
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Run linting
      run: |
        npm run lint
        python -m flake8 src/
        python -m mypy src/
    
    - name: Run unit tests
      run: |
        npm run test:unit
        python -m pytest tests/unit/ --cov=src/ --cov-report=xml
    
    - name: Run integration tests
      run: |
        npm run test:integration
        python -m pytest tests/integration/
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info,./coverage.xml
        flags: unittests
        name: codecov-umbrella

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Snyk to check for vulnerabilities
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  build:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Build, tag, and push game-engine image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY/game-engine:$IMAGE_TAG ./src/game-engine
        docker push $ECR_REGISTRY/$ECR_REPOSITORY/game-engine:$IMAGE_TAG
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY/game-engine:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY/game-engine:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY/game-engine:latest
    
    - name: Build, tag, and push user-service image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY/user-service:$IMAGE_TAG ./src/user-service
        docker push $ECR_REGISTRY/$ECR_REPOSITORY/user-service:$IMAGE_TAG
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY/user-service:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY/user-service:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY/user-service:latest
    
    - name: Build, tag, and push leaderboard-service image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY/leaderboard-service:$IMAGE_TAG ./src/leaderboard-service
        docker push $ECR_REGISTRY/$ECR_REPOSITORY/leaderboard-service:$IMAGE_TAG
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY/leaderboard-service:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY/leaderboard-service:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY/leaderboard-service:latest

  infrastructure-validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Terraform Format Check
      run: terraform fmt -check -recursive infrastructure/terraform/
    
    - name: Terraform Init
      run: |
        cd infrastructure/terraform/environments/dev
        terraform init
    
    - name: Terraform Validate
      run: |
        cd infrastructure/terraform/environments/dev
        terraform validate
    
    - name: Terraform Plan
      run: |
        cd infrastructure/terraform/environments/dev
        terraform plan -out=tfplan
    
    - name: Upload Terraform Plan
      uses: actions/upload-artifact@v3
      with:
        name: terraform-plan
        path: infrastructure/terraform/environments/dev/tfplan

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [build, infrastructure-validate]
    if: github.ref == 'refs/heads/develop'
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    - name: Deploy Infrastructure
      run: |
        cd infrastructure/terraform/environments/dev
        terraform init
        terraform apply -auto-approve
    
    - name: Deploy Applications
      run: |
        # Update ECS services with new image tags
        aws ecs update-service --cluster game-cluster-dev --service game-engine-service --force-new-deployment
        aws ecs update-service --cluster game-cluster-dev --service user-service --force-new-deployment
        aws ecs update-service --cluster game-cluster-dev --service leaderboard-service --force-new-deployment
    
    - name: Run Smoke Tests
      run: |
        npm run test:smoke -- --env=development

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    if: github.ref == 'refs/heads/main'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    - name: Deploy Infrastructure
      run: |
        cd infrastructure/terraform/environments/staging
        terraform init
        terraform apply -auto-approve
    
    - name: Deploy Applications
      run: |
        aws ecs update-service --cluster game-cluster-staging --service game-engine-service --force-new-deployment
        aws ecs update-service --cluster game-cluster-staging --service user-service --force-new-deployment
        aws ecs update-service --cluster game-cluster-staging --service leaderboard-service --force-new-deployment
    
    - name: Run E2E Tests
      run: |
        npm run test:e2e -- --env=staging

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Manual Approval Required
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.TOKEN }}
        approvers: tech-lead,devops-lead
        minimum-approvals: 2
        issue-title: "Production Deployment Approval Required"
    
    - name: Blue-Green Deployment
      run: |
        # Implement blue-green deployment logic
        ./scripts/blue-green-deploy.sh production
    
    - name: Post-Deployment Validation
      run: |
        npm run test:smoke -- --env=production
        ./scripts/validate-deployment.sh production